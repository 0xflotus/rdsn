<html>
	<head>
		<title>Simple Line Graph using SVG and d3.js</title>
		<meta charset="utf-8">
		<script src="js/jquery.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/epoch.min.js"></script>
		<link rel="stylesheet" type="text/css" href="css/epoch.min.css">  
    </style>
	</head>
	<body style = "margin: 0;">
		<div id = "chart" >
			<div id="real-time-legend" class="epoch category20" style="float: left; width: 150px;"></div>
			<div id="real-time-chart" class="epoch category20" style="float: left; height: 600px;"></div>
		</div>
		
		<script>
		
		$(function() {
		
			var width = 150;
			var height = 600;
			var legendRectSize = 20;
			var legendSpacing = 5; 
			var color = d3.scale.category20();
			var chart;
			var dataid = Get_Query_String('id');
			var tagreload = false;
			
			var svg_legend = d3.select('#real-time-legend')
				.append('svg')
				.attr('width', width)
				.attr('height', height)
				.append('g')
				.attr('transform', 'translate( 10, 50 )');
			
			var datanum;
			var data = { chart: [], label: [], view: "", target: "", percentile: "" };
			var ChartType;
			$.getJSON ("/data" + dataid + ".json", function (d)
			{
				ChartType = d.type;
				data.view = d.view;
				data.target = d.target;
				data.percentile = d.percentile;
				for (var i in d.newdata)
				{
					data.label.push(d.label[i]);
					data.chart.push({ values: [] });
					data.chart[i].values.push(d.newdata[i]);
				}
			})
			.done(Render)
			.fail(function(d, textStatus, error) {alert("getJSON failed, status: " + textStatus + ", error: "+error); });
			
			function Get_Query_String(name)
			{
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r != null)
					return unescape(r[2]);
				return null;
			}
			
			function Render()
			{
				Render_Legend();
				Render_Chart();
				//Render_Chart();
			}
			
			function Render_Legend()
			{
				var legend = svg_legend.selectAll('.legend')
				.data(data.label)
				.enter()
				.append('g')
				.attr('class', 'legend')
				.attr('transform', function(d, i) {
					return 'translate( 0, ' + i * (legendRectSize + legendSpacing) + ')';
				})
				.style('font-size', '10px')
				.style('padding', '0')
				.style('border', '0');
				
				legend.append('rect')
				.attr('width', legendRectSize)
				.attr('height', legendRectSize)
				.style('fill', function(d, i) { return color(i) })
				.style('stroke-width', '0.5')
				.style('stroke', 'black');
          
				legend.append('text')
				.attr('x', legendRectSize + legendSpacing)
				.attr('y', legendRectSize - legendSpacing)
				.text(function(d) { return d; });
			}
			
			function Render_Chart()
			{
				document.getElementById('real-time-chart').innerHTML="";
				
				chart = $('#real-time-chart').epoch({
					type: ChartType,
					data: data.chart,
					axes: ['left', 'bottom', 'right'],
					historySize: 1,
					width : window.innerWidth - 150,
					margins: { top: 20, right: 40, bottom: 30, left: 40 }
				});
				
				setInterval(Data_Insert, 1000);
				Data_Insert();
			}
			
			function Data_Insert()
			{
				var newdata = [];
				var nowtime = ((new Date()).getTime() / 1000) | 0;
				$.getJSON ("/data" + dataid + ".json", function (d)
				{
					if ((data.view != d.view) || (data.target != d.target) || (data.percentile != d.percentile) || (ChartType != d.type))
					{
						location.reload();
					}
					
					for (var i in d.label)
					{
						var flag = true;
						for (var j in data.label)
						{
							if (d.label[i] == data.label[j])
							{
								flag = false;
								break;
							}
						}
						if (flag == true)
						{
							location.reload();
						}
					}
					
					for (var i in data.label)
					{
						var flag = true;
						for (var j in d.label)
						{
							if (data.label[i] == d.label[j])
							{
								flag = false;
								break;
							}
						}
						if (flag == true)
						{
							location.reload();
						}
					}
					
					newdata = d.newdata;
					for (var i in d.label)
					{
						newdata[i].time = nowtime;
					}
					chart.push(newdata);
					
				})
				//.fail(function(d, textStatus, error) {alert("getJSON failed, status: " + textStatus + ", error: "+error); });
			}
		});
		</script>
		
	</body>
</html>